<!DOCTYPE html>
<html>
<head>
  <title>Touchpad</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: #222;
      touch-action: none;
    }

    #pad {
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #333, #111);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 18px;
      user-select: none;
    }
  </style>
</head>

<body>
  <div id="pad">Touchpad</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.on('connect', () => console.log('touchpad connected', socket.id));
    socket.on('server-message', (m) => console.log('server:', m));
    const pad = document.getElementById("pad");

    let lastTouch = null;
    let tapTimer = null;
    let tapCount = 0;
    let isDragging = false;

    const TAP_DELAY = 250;
    const HOLD_DELAY = 120;

    pad.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        lastTouch = e.touches[0];
        isDragging = false;

        tapTimer = setTimeout(() => {
          isDragging = true;
          const ev = { type: "down" };
          console.log('touchpad emit', ev);
          socket.emit("cursor-event", ev);
        }, HOLD_DELAY);
      }

      if (e.touches.length === 2) {
        socket.emit("cursor-event", { type: "scrollStart" });
      }
    });

    pad.addEventListener("touchmove", (e) => {
      e.preventDefault();

      if (e.touches.length === 1 && lastTouch) {
        const t = e.touches[0];
        const dx = t.clientX - lastTouch.clientX;
        const dy = t.clientY - lastTouch.clientY;
        lastTouch = t;

        const ev = { type: "move", dx, dy };
        console.log('touchpad emit', ev);
        socket.emit("cursor-event", ev);
      }

      if (e.touches.length === 2) {
        const t1 = e.touches[0];
        const t2 = e.touches[1];
        const avgY = (t1.clientY + t2.clientY) / 2;

        socket.emit("cursor-event", {
          type: "scroll",
          dy: avgY
        });
      }
    }, { passive: false });

    pad.addEventListener("touchend", () => {
      clearTimeout(tapTimer);

      if (isDragging) {
        const ev = { type: "up" };
        console.log('touchpad emit', ev);
        socket.emit("cursor-event", ev);
        isDragging = false;
        return;
      }

      tapCount++;

      setTimeout(() => {
        if (tapCount === 1) {
          const ev = { type: "click" };
          console.log('touchpad emit', ev);
          socket.emit("cursor-event", ev);
        }

        if (tapCount === 2) {
          const ev = { type: "doubleClick" };
          console.log('touchpad emit', ev);
          socket.emit("cursor-event", ev);
        }

        tapCount = 0;
      }, TAP_DELAY);
    });
  </script>
</body>
</html>
